.. include:: /include/substitution.rst

.. _configuring_training_parameters_detection:

*****************
Object Detection
*****************

* :ref:`detection-config-files-mainconfig`
* :ref:`detection-config-files-use-case`
* :ref:`detection-config-files-datamodule`
* :ref:`detection-config-files-dataset`
* :ref:`detection-config-files-model`
* :ref:`detection-config-files-model_analysis`
* :ref:`detection-config-files-trainer`

.. note::

    Object Detection training pipeline requires an Nvidia GPU with CUDA support to run

.. _detection-config-files-mainconfig:

Main Config
===========

Config File: ``peekingduck/training/configs/config.yaml``

+---------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Key                                   | Value                                               | Description                                                                                                                                                |
+=======================================+=====================================================+============================================================================================================================================================+
| :mod:`project_name`                   | “your_project_name”                                 | your_project_name will be used as your output folder                                                                                                       |
+---------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
| :mod:`defaults`                       |                                                     |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :mod:`use_case`                    | detection                                           | Type of the model to be trained and used.                                                                                                                  |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`data_module`                | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`model`                      | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`trainer`                    | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`callbacks`                  | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`metrics`                    | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`model_analysis`             | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`stores`                     | :grey:`${use_case}`                                 |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`override hydra/job_logging` | :grey:`custom`                                      |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
| :grey:`hydra`                         |                                                     |                                                                                                                                                            |
+--+------------------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`run`                        |                                                     |                                                                                                                                                            |
+--+-----------+------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  |           | :grey:`dir`            | :grey:`outputs/${project_name}/${stores.unique_id}` |                                                                                                                                                            |
+--+-----------+------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  | :grey:`sweep`                      |                                                     |                                                                                                                                                            |
+--+-----------+------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  |           | :grey:`dir`            | :grey:`outputs/${project_name}/${stores.unique_id}` |                                                                                                                                                            |
+--+-----------+------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  |           | :grey:`subdir`         | :grey:`${hydra.job.num}`                            |                                                                                                                                                            |
+--+-----------+------------------------+-----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+

----------

.. _detection-config-files-use-case:

Use Case
========

Config File : ``peekingduck/training/configs/use_case/detection.yaml``

+----------------------------+----------------------------------------------------+-----------------------------------------------------+
| Key                        | Value                                              | Description                                         |
+============================+====================================================+=====================================================+
| :grey:`pipeline`           |:grey:`detection`                                   |                                                     |
+----------------------------+----------------------------------------------------+-----------------------------------------------------+
| :mod:`random_state`        | null                                               | Training seed value.                                |
+----------------------------+----------------------------------------------------+-----------------------------------------------------+


----------

.. _detection-config-files-datamodule:

Data Module
===========

Config File : ``peekingduck/training/configs/data_module/detection.yaml``

+---------------------------------------------------------+----------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+
| Key                                                     | Value                                              | Description                                                                                                                               |
+=========================================================+====================================================+========+==================================================================================================================================+
| :mod:`dataset_format`                                   | "coco"                                             | "coco" | 'voc'                                                                                                                            |
+--------------------------+------------------------------+----------------------------------------------------+--------+----------------------------------------------------------------------------------------------------------------------------------+
| :mod:`defaults`          |                              |                                                    |                                                                                                                                           |
+--------------------------+------------------------------+----------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+
|                          | :mod:`dataset`               | fashion_coco_format                                | Selecting the datamodule/dataset file : fashion_coco_format | fashion_voc_format | < custom dataset yaml file name >                      |
+--------------------------+------------------------------+----------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+

----------

.. _detection-config-files-dataset:

Dataset
=======

.. tabs::

   .. tab:: COCO Format

        Config File: ``peekingduck/training/configs/data_module/dataset/fashion_coco_format.yaml``

        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | Key                                   | Value                                                                             | Description                                                |
        +=======================================+===================================================================================+============================================================+
        | :mod:`download`                       | True                                                                              | Whether to download dataset                                |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`url`                            | "https://storage.googleapis.com/peekingduck/data/fashion_coco_format.zip"         | url to download dataset                                    |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`blob_file`                      | "fashion_coco_format.zip"                                                         | Filename of dataset                                        |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`root_dir`                       | "data"                                                                            | Dataset folder                                             |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`data_dir`                       | "${.root_dir}/fashion_dataset_for_object_detection_coco_format"                   | full path to dataset                                       |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`num_classes`                    | 11                                                                                | Number of classes in dataset                               |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`train_ann`                      | "instances_train2017.json"                                                        | Annotation filename for training set                       |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`val_ann`                        | "instances_val2017.json"                                                          | Annotation filename for validation set                     |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`test_ann`                       | null                                                                              | Annotation filename for test set                           |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :grey:`image_sets`                    | null                                                                              |                                                            |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+

   .. tab:: VOC Format

        Config File: ``peekingduck/training/configs/data_module/dataset/fashion_voc_format.yaml``

        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | Key                                   | Value                                                                             | Description                                                |
        +=======================================+===================================================================================+============================================================+
        | :mod:`download`                       | True                                                                              | Whether to download dataset                                |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`url`                            | "https://storage.googleapis.com/peekingduck/data/fashion_voc_format.zip"          | url to download dataset                                    |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`blob_file`                      | "fashion_voc_format.zip"                                                          | Filename of dataset                                        |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`root_dir`                       | "data"                                                                            | Dataset folder                                             |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`data_dir`                       | "${.root_dir}/fashion_dataset_for_object_detection_voc_format"                    | full path to dataset                                       |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`num_classes`                    | 10                                                                                | Number of classes in dataset                               |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :grey:`train_ann`                     | null                                                                              | Annotation filename for training set                       |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :grey:`val_ann`                       | null                                                                              | Annotation filename for validation set                     |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :grey:`test_ann`                      | null                                                                              | Annotation filename for test set                           |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+
        | :mod:`image_sets`                     | [['2007, 'trainval']]                                                             | Year and Image sets                                        |
        +---------------------------------------+-----------------------------------------------------------------------------------+------------------------------------------------------------+

----------


.. _detection-config-files-model:

Model
=====


| The model class will make use of these configs.
| Config File : ``peekingduck/training/configs/model/detection.yaml``

+------------------------------------------------------------------+----------------------------------------------+----------------+
| Key                                                              | Value                                        | Description    |
+==================================================================+==============================================+================+
| :grey:`yolox_s`                                                  |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`0.33`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`0.50`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`input_size`          | :grey:`[224, 224]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`test_size`           | :grey:`[224, 224]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
| :grey:`yolox_m`                                                  |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`0.67`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`0.75`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
| :grey:`yolox_l`                                                  |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`0.1`                                  |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`0.1`                                  |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
| :grey:`yolox_x`                                                  |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`1.33`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`1.25`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
| :grey:`yolox_nano`                                               |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`0.33`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`0.25`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`mosaic_scale`        | :grey:`[0.5, 1.5]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`random_size`         | :grey:`[10, 20]`                             |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`input_size`          | :grey:`[416, 416]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`test_size`           | :grey:`[416, 416]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`mosaic_prob`         | :grey:`0.5`                                  |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`enable_mixup`        | :grey:`False`                                |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
| :grey:`yolox_tiny`                                               |                                              |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`depth`               | :grey:`0.33`                                 |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`width`               | :grey:`0.375`                                |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`mosaic_scale`        | :grey:`[0.5, 1.5]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`random_size`         | :grey:`[10, 20]`                             |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`input_size`          | :grey:`[416, 416]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`test_size`           | :grey:`[416, 416]`                           |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+
|                                    | :grey:`enable_mixup`        | :grey:`False`                                |                |
+------------------------------------+-----------------------------+----------------------------------------------+----------------+

----------


.. _detection-config-files-model_analysis:

Model Analysis
==============


| The model_analysis class will make use of these configs.
| Config File : ``peekingduck/training/configs/model_analysis/detection.yaml``

+--------------------------------------------------------------------+----------------------------------------------------------+----------------+
| Key                                                                | Value                                                    | Description    |
+====================================================================+==========================================================+================+
| :grey:`wandb`                                                      |                                                          |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-project`         | :grey:`${project_name}`                                  |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-entity`          | :grey:`${project_name}`                                  |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-name`            | :grey:`${project_name}-${stores.unique_id}`              |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-id`              | :grey:`${stores.unique_id}`                              |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-save_dir`        | :grey:`"./outputs/${project_name}/${stores.unique_id}/"` |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-num_eval_images` | :grey:`null`                                             |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+
|                                    | :grey:`wandb-log_checkpoints` | :grey:`True`                                             |                |
+------------------------------------+-------------------------------+----------------------------------------------------------+----------------+

----------


.. _detection-config-files-trainer:

Trainer
=======

| The trainer class will make use of these configs.
| Config File : ``peekingduck/training/configs/trainer/detection.yaml``

+--------------------------------------------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
| Key                                                                                        | Value                                                  | Description                                                                                                                                        |
+============================================================================================+========================================================+====================================================================================================================================================+
| :grey:`yolox`                                                                              |                                                        |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :grey:`experiment_name`                               | :grey:`${project_name}`                                |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`name`                                           | null                                                   | Dataset name to be printed in the logs (wandb)                                                                                                     |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`resume`                                         | False                                                  | Resume training                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`devices`                                        | 1                                                      | Specify number of GPUS available                                                                                                                   |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`batch_size`                                     | 8                                                      | Batch size                                                                                                                                         |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`max_epoch`                                      | 10                                                     | Number of epochs to train                                                                                                                          |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+-----------------+----------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`fp16`                                           | True                                                   | True | null     | Enable or disable floating point mix precision training                                                                          |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+-----------------+----------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`occupy`                                         | null                                                   | True | null     | Occupy GPU memory for faster training (May need to turn it off if GPU memory is less than 4 GB)                                  |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+-----------+-----+-----+-----------+-----------+--------------+-------------------------------------------------------------------------------------+
|                                    | :mod:`model`                                          | :mod:`yolox_s`                                         | "yolox_s" | "yolox_m" | "yolox_l" | "yolox_x" | "yolox_nano" | "yolox_tiny"                                                                        |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+-----------+-----------+-----------+-----------+--------------+-------------------------------------------------------------------------------------+
|                                    | :mod:`ckpt`                                           | null                                                   | Specify pre trained weights file if any                                                                                                            |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+---------------+------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`logger`                                         | tensorboard                                            | "tensorboard" | "wandb"                                                                                                                            |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+---------------+------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`cache`                                          | null                                                   |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`dist_url`                                       | null                                                   |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`num_machines`                                   | 1                                                      |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`machine_rank`                                   | null                                                   |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`dist_backend`                                   | null                                                   |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :mod:`output_dir`                                     | './outputs'                                            |                                                                                                                                                    |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+
|                                    | :grey:`seed`                                          | :grey:`${use_case.random_state}`                       | Random seed. Default value will reference directly from the main object detection use case config file.                                                             |
+------------------------------------+-------------------------------------------------------+--------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------+




